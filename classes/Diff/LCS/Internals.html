<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Diff::LCS::Internals</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>


    <meta property="og:title" value="Diff::LCS::Internals">

  

    <meta name="keywords" content="Diff::LCS::Internals class">
  
    <meta name="keywords" content="lcs, analyze_patchset, intuit_diff_direction">
  
</head>

<body>
    <div class="banner">
        
        <h1>
            <span class="type">Module</span>
            Diff::LCS::Internals
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/vendor/bundle/ruby/2_6_0/gems/diff-lcs-1_3/lib/diff/lcs/internals_rb.html">vendor/bundle/ruby/2.6.0/gems/diff-lcs-1.3/lib/diff/lcs/internals.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-analyze_patchset">analyze_patchset</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-intuit_diff_direction">intuit_diff_direction</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-lcs">lcs</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-analyze_patchset">
            
              <b>analyze_patchset</b>(patchset, depth = 0)
            
            <a href="../../../classes/Diff/LCS/Internals.html#method-c-analyze_patchset" name="method-c-analyze_patchset" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>This method will analyze the provided patchset to provide a single-pass normalization (conversion of the array form of Diff::LCS::Change objects to the object form of same) and detection of whether the patchset represents changes to be made.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-analyze_patchset_source')" id="l_method-c-analyze_patchset_source">show</a>
                
              </p>
              <div id="method-c-analyze_patchset_source" class="dyn-source">
                <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.6.0/gems/diff-lcs-1.3/lib/diff/lcs/internals.rb, line 99</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">analyze_patchset</span>(<span class="ruby-identifier">patchset</span>, <span class="ruby-identifier">depth</span> = <span class="ruby-value">0</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Patchset too complex&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">depth</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>

  <span class="ruby-identifier">has_changes</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-comment"># Format:</span>
  <span class="ruby-comment"># [ # patchset</span>
  <span class="ruby-comment">#   # hunk (change)</span>
  <span class="ruby-comment">#   [ # hunk</span>
  <span class="ruby-comment">#     # change</span>
  <span class="ruby-comment">#   ]</span>
  <span class="ruby-comment"># ]</span>

  <span class="ruby-identifier">patchset</span> = <span class="ruby-identifier">patchset</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hunk</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">hunk</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Diff</span><span class="ruby-operator">::</span><span class="ruby-constant">LCS</span><span class="ruby-operator">::</span><span class="ruby-constant">Change</span>
      <span class="ruby-identifier">has_changes</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">!</span><span class="ruby-identifier">hunk</span>.<span class="ruby-identifier">unchanged?</span>
      <span class="ruby-identifier">hunk</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Array</span>
      <span class="ruby-comment"># Detect if the &#39;hunk&#39; is actually an array-format</span>
      <span class="ruby-comment"># Change object.</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">Diff</span><span class="ruby-operator">::</span><span class="ruby-constant">LCS</span><span class="ruby-operator">::</span><span class="ruby-constant">Change</span>.<span class="ruby-identifier">valid_action?</span> <span class="ruby-identifier">hunk</span>[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">hunk</span> = <span class="ruby-constant">Diff</span><span class="ruby-operator">::</span><span class="ruby-constant">LCS</span><span class="ruby-operator">::</span><span class="ruby-constant">Change</span>.<span class="ruby-identifier">from_a</span>(<span class="ruby-identifier">hunk</span>)
        <span class="ruby-identifier">has_changes</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">!</span><span class="ruby-identifier">hunk</span>.<span class="ruby-identifier">unchanged?</span>
        <span class="ruby-identifier">hunk</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">with_changes</span>, <span class="ruby-identifier">hunk</span> = <span class="ruby-identifier">analyze_patchset</span>(<span class="ruby-identifier">hunk</span>, <span class="ruby-identifier">depth</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
        <span class="ruby-identifier">has_changes</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">with_changes</span>
        <span class="ruby-identifier">hunk</span>.<span class="ruby-identifier">flatten</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;Cannot normalise a hunk of class #{hunk.class}.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  [ <span class="ruby-identifier">has_changes</span>, <span class="ruby-identifier">patchset</span>.<span class="ruby-identifier">flatten</span>(<span class="ruby-value">1</span>) ]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-intuit_diff_direction">
            
              <b>intuit_diff_direction</b>(src, patchset, limit = nil)
            
            <a href="../../../classes/Diff/LCS/Internals.html#method-c-intuit_diff_direction" name="method-c-intuit_diff_direction" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Examine the patchset and the source to see in which direction the patch should be applied.</p>

<p>WARNING: By default, this examines the whole patch, so this could take some time. This also works better with Diff::LCS::ContextChange or Diff::LCS::Change as its source, as an array will cause the creation of one of the above.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-intuit_diff_direction_source')" id="l_method-c-intuit_diff_direction_source">show</a>
                
              </p>
              <div id="method-c-intuit_diff_direction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.6.0/gems/diff-lcs-1.3/lib/diff/lcs/internals.rb, line 144</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">intuit_diff_direction</span>(<span class="ruby-identifier">src</span>, <span class="ruby-identifier">patchset</span>, <span class="ruby-identifier">limit</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">string</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">String</span>)
  <span class="ruby-identifier">count</span> = <span class="ruby-identifier">left_match</span> = <span class="ruby-identifier">left_miss</span> = <span class="ruby-identifier">right_match</span> = <span class="ruby-identifier">right_miss</span> = <span class="ruby-value">0</span>

  <span class="ruby-identifier">patchset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">change</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">change</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Diff</span><span class="ruby-operator">::</span><span class="ruby-constant">LCS</span><span class="ruby-operator">::</span><span class="ruby-constant">ContextChange</span>
      <span class="ruby-identifier">le</span> = <span class="ruby-identifier">string</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">src</span>[<span class="ruby-identifier">change</span>.<span class="ruby-identifier">old_position</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">src</span>[<span class="ruby-identifier">change</span>.<span class="ruby-identifier">old_position</span>]
      <span class="ruby-identifier">re</span> = <span class="ruby-identifier">string</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">src</span>[<span class="ruby-identifier">change</span>.<span class="ruby-identifier">new_position</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">src</span>[<span class="ruby-identifier">change</span>.<span class="ruby-identifier">new_position</span>]

      <span class="ruby-keyword">case</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">action</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;-&#39;</span> <span class="ruby-comment"># Remove details from the old string</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">le</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">old_element</span>
          <span class="ruby-identifier">left_match</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">left_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;+&#39;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">re</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">new_element</span>
          <span class="ruby-identifier">right_match</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">right_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;=&#39;</span>
        <span class="ruby-identifier">left_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">le</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">old_element</span>
        <span class="ruby-identifier">right_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">re</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">new_element</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;!&#39;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">le</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">old_element</span>
          <span class="ruby-identifier">left_match</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">re</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">new_element</span>
            <span class="ruby-identifier">right_match</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">left_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
            <span class="ruby-identifier">right_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Diff</span><span class="ruby-operator">::</span><span class="ruby-constant">LCS</span><span class="ruby-operator">::</span><span class="ruby-constant">Change</span>
      <span class="ruby-comment"># With a simplistic change, we can&#39;t tell the difference between</span>
      <span class="ruby-comment"># the left and right on &#39;!&#39; actions, so we ignore those. On &#39;=&#39;</span>
      <span class="ruby-comment"># actions, if there&#39;s a miss, we miss both left and right.</span>
      <span class="ruby-identifier">element</span> = <span class="ruby-identifier">string</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">src</span>[<span class="ruby-identifier">change</span>.<span class="ruby-identifier">position</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">src</span>[<span class="ruby-identifier">change</span>.<span class="ruby-identifier">position</span>]

      <span class="ruby-keyword">case</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">action</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;-&#39;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">element</span>
          <span class="ruby-identifier">left_match</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">left_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;+&#39;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">element</span>
          <span class="ruby-identifier">right_match</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">right_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;=&#39;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">element</span>
          <span class="ruby-identifier">left_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
          <span class="ruby-identifier">right_miss</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-keyword">not</span> <span class="ruby-identifier">limit</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">limit</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">no_left</span> = (<span class="ruby-identifier">left_match</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">left_miss</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
  <span class="ruby-identifier">no_right</span> = (<span class="ruby-identifier">right_match</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">right_miss</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)

  <span class="ruby-keyword">case</span> [ <span class="ruby-identifier">no_left</span>, <span class="ruby-identifier">no_right</span> ]
  <span class="ruby-keyword">when</span> [ <span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span> ]
    <span class="ruby-value">:patch</span>
  <span class="ruby-keyword">when</span> [ <span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span> ]
    <span class="ruby-value">:unpatch</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">left_match</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">right_match</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">left_miss</span>.<span class="ruby-identifier">zero?</span>
        <span class="ruby-value">:patch</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-value">:unpatch</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">-1</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">right_miss</span>.<span class="ruby-identifier">zero?</span>
        <span class="ruby-value">:unpatch</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-value">:patch</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;The provided patchset does not appear to apply to the provided enumerable as either source or destination value.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-lcs">
            
              <b>lcs</b>(a, b)
            
            <a href="../../../classes/Diff/LCS/Internals.html#method-c-lcs" name="method-c-lcs" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Compute the longest common subsequence between the sequenced Enumerables <code>a</code> and <code>b</code>. The result is an array whose contents is such that</p>

<pre><code>result = Diff::LCS::Internals.lcs(a, b)
result.each_with_index do |e, i|
  assert_equal(a[i], b[e]) unless e.nil?
end
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-lcs_source')" id="l_method-c-lcs_source">show</a>
                
              </p>
              <div id="method-c-lcs_source" class="dyn-source">
                <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.6.0/gems/diff-lcs-1.3/lib/diff/lcs/internals.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lcs</span>(<span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span>)
  <span class="ruby-identifier">a_start</span> = <span class="ruby-identifier">b_start</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">a_finish</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">b_finish</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">vector</span> = []

  <span class="ruby-comment"># Prune off any common elements at the beginning...</span>
  <span class="ruby-keyword">while</span> ((<span class="ruby-identifier">a_start</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">a_finish</span>) <span class="ruby-keyword">and</span> (<span class="ruby-identifier">b_start</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">b_finish</span>) <span class="ruby-keyword">and</span>
         (<span class="ruby-identifier">a</span>[<span class="ruby-identifier">a_start</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>[<span class="ruby-identifier">b_start</span>]))
    <span class="ruby-identifier">vector</span>[<span class="ruby-identifier">a_start</span>] = <span class="ruby-identifier">b_start</span>
    <span class="ruby-identifier">a_start</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">b_start</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">b_start</span> = <span class="ruby-identifier">a_start</span>

  <span class="ruby-comment"># Now the end...</span>
  <span class="ruby-keyword">while</span> ((<span class="ruby-identifier">a_start</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">a_finish</span>) <span class="ruby-keyword">and</span> (<span class="ruby-identifier">b_start</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">b_finish</span>) <span class="ruby-keyword">and</span>
         (<span class="ruby-identifier">a</span>[<span class="ruby-identifier">a_finish</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>[<span class="ruby-identifier">b_finish</span>]))
    <span class="ruby-identifier">vector</span>[<span class="ruby-identifier">a_finish</span>] = <span class="ruby-identifier">b_finish</span>
    <span class="ruby-identifier">a_finish</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">b_finish</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Now, compute the equivalence classes of positions of elements.</span>
  <span class="ruby-identifier">b_matches</span> = <span class="ruby-identifier">position_hash</span>(<span class="ruby-identifier">b</span>, <span class="ruby-identifier">b_start</span><span class="ruby-operator">..</span><span class="ruby-identifier">b_finish</span>)

  <span class="ruby-identifier">thresh</span> = []
  <span class="ruby-identifier">links</span>  = []
  <span class="ruby-identifier">string</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">String</span>)

  (<span class="ruby-identifier">a_start</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">a_finish</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">ai</span> = <span class="ruby-identifier">string</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">a</span>[<span class="ruby-identifier">i</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">a</span>[<span class="ruby-identifier">i</span>]
    <span class="ruby-identifier">bm</span> = <span class="ruby-identifier">b_matches</span>[<span class="ruby-identifier">ai</span>]
    <span class="ruby-identifier">k</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">bm</span>.<span class="ruby-identifier">reverse_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">thresh</span>[<span class="ruby-identifier">k</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">j</span>) <span class="ruby-keyword">and</span> (<span class="ruby-identifier">thresh</span>[<span class="ruby-identifier">k</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">j</span>)
        <span class="ruby-identifier">thresh</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">j</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">k</span> = <span class="ruby-identifier">replace_next_larger</span>(<span class="ruby-identifier">thresh</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">k</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">links</span>[<span class="ruby-identifier">k</span>] = [ (<span class="ruby-identifier">k</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">links</span>[<span class="ruby-identifier">k</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span> ] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">thresh</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">link</span> = <span class="ruby-identifier">links</span>[<span class="ruby-identifier">thresh</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
    <span class="ruby-keyword">while</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">link</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">vector</span>[<span class="ruby-identifier">link</span>[<span class="ruby-value">1</span>]] = <span class="ruby-identifier">link</span>[<span class="ruby-value">2</span>]
      <span class="ruby-identifier">link</span> = <span class="ruby-identifier">link</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">vector</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
    
  
</div>

    </div>
  </body>
</html>
