<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>RSpec::CallerFilter</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>


    <meta property="og:title" value="RSpec::CallerFilter">

  
    
    <meta name="description" content="Consistent implementation for “cleaning” the caller method to strip out non-rspec lines.">
    <meta property="og:description" content="Consistent implementation for “cleaning” the caller method to strip out non-rspec lines.">
  

    <meta name="keywords" content="RSpec::CallerFilter class">
  
    <meta name="keywords" content="first_non_rspec_line">
  
</head>

<body>
    <div class="banner">
        
        <h1>
            <span class="type">Class</span>
            RSpec::CallerFilter
            
                <span class="parent">&lt;
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/vendor/bundle/ruby/2_6_0/gems/rspec-support-3_8_0/lib/rspec/support/caller_filter_rb.html">vendor/bundle/ruby/2.6.0/gems/rspec-support-3.8.0/lib/rspec/support/caller_filter.rb</a></li>
            
            <li><a href="../../files/vendor/bundle/ruby/2_6_0/gems/rspec-support-3_8_0/lib/rspec/support/spec/library_wide_checks_rb.html">vendor/bundle/ruby/2.6.0/gems/rspec-support-3.8.0/lib/rspec/support/spec/library_wide_checks.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Consistent implementation for “cleaning” the caller method to strip out non-rspec lines. This enables errors to be reported at the call site in the code using the library, which is far more useful than the particular internal method that raised an error.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-first_non_rspec_line">first_non_rspec_line</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <div class="sectiontitle">Constants</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">RSPEC_LIBS</td>
            <td>=</td>
            <td class="attr-value">%w[
core
mocks
expectations
support
matchers
rails
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ADDITIONAL_TOP_LEVEL_FILES</td>
            <td>=</td>
            <td class="attr-value">%w[ autorun ]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LIB_REGEX</td>
            <td>=</td>
            <td class="attr-value">%r{/lib/rspec/(#{(RSPEC_LIBS + ADDITIONAL_TOP_LEVEL_FILES).join(&#39;|&#39;)})(\.rb|/)}</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IGNORE_REGEX</td>
            <td>=</td>
            <td class="attr-value">Regexp.union(LIB_REGEX, &quot;rubygems/core_ext/kernel_require.rb&quot;)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>rubygems/core_ext/kernel_require.rb isn&#39;t actually part of rspec (obviously) but we want it ignored when we are looking for the first meaningful line of the backtrace outside of <a href="../RSpec.html"><code>RSpec</code></a>. It can show up in the backtrace as the immediate first caller when `CallerFilter.first_non_rspec_line` is called from the top level of a required file, but it depends on if rubygems is loaded or not. We don&#39;t want to have to deal with this complexity in our `RSpec.deprecate` calls, so we ignore it here.</p></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-first_non_rspec_line">
            
              <b>first_non_rspec_line</b>(skip_frames=3, increment=5)
            
            <a href="../../classes/RSpec/CallerFilter.html#method-c-first_non_rspec_line" name="method-c-first_non_rspec_line" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>This supports args because it&#39;s more efficient when the caller specifies these. It allows us to skip frames the caller knows are part of <a href="../RSpec.html"><code>RSpec</code></a>, and to decrease the increment size if the caller is confident the line will be found in a small number of stack frames from `skip_frames`.</p>

<p>Note that there is a risk to passing a `skip_frames` value that is too high: If it skippped the first non-rspec line, then this method would return the 2nd or 3rd (or whatever) non-rspec line. Thus, you generally shouldn&#39;t pass values for these parameters, particularly since most places that use this are not hot spots (generally it gets used for deprecation warnings). However, if you do have a hot spot that calls this, passing `skip_frames` can make a significant difference. Just make sure that that particular use is tested so that if the provided `skip_frames` changes to no longer be accurate in such a way that would return the wrong stack frame, a test will fail to tell you.</p>

<p>See benchmarks/skip_frames_for_caller_filter.rb for measurements.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-first_non_rspec_line_source')" id="l_method-c-first_non_rspec_line_source">show</a>
                
              </p>
              <div id="method-c-first_non_rspec_line_source" class="dyn-source">
                <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.6.0/gems/rspec-support-3.8.0/lib/rspec/support/caller_filter.rb, line 47</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">first_non_rspec_line</span>(<span class="ruby-identifier">skip_frames</span>=<span class="ruby-value">3</span>, <span class="ruby-identifier">increment</span>=<span class="ruby-value">5</span>)
  <span class="ruby-comment"># Why a default `skip_frames` of 3?</span>
  <span class="ruby-comment"># By the time `caller_locations` is called below, the first 3 frames are:</span>
  <span class="ruby-comment">#   lib/rspec/support/caller_filter.rb:63:in `block in first_non_rspec_line&#39;</span>
  <span class="ruby-comment">#   lib/rspec/support/caller_filter.rb:62:in `loop&#39;</span>
  <span class="ruby-comment">#   lib/rspec/support/caller_filter.rb:62:in `first_non_rspec_line&#39;</span>

  <span class="ruby-comment"># `caller` is an expensive method that scales linearly with the size of</span>
  <span class="ruby-comment"># the stack. The performance hit for fetching it in chunks is small,</span>
  <span class="ruby-comment"># and since the target line is probably near the top of the stack, the</span>
  <span class="ruby-comment"># overall improvement of a chunked search like this is significant.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># See benchmarks/caller.rb for measurements.</span>

  <span class="ruby-comment"># The default increment of 5 for this method are mostly arbitrary, but</span>
  <span class="ruby-comment"># is chosen to give good performance on the common case of creating a double.</span>

  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">caller_locations</span>(<span class="ruby-identifier">skip_frames</span>, <span class="ruby-identifier">increment</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;No non-lib lines in stack&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">stack</span>

    <span class="ruby-identifier">line</span> = <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">path</span> <span class="ruby-operator">!~</span> <span class="ruby-constant">IGNORE_REGEX</span> }
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">line</span>

    <span class="ruby-identifier">skip_frames</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">increment</span>
    <span class="ruby-identifier">increment</span>   <span class="ruby-operator">*=</span> <span class="ruby-value">2</span> <span class="ruby-comment"># The choice of two here is arbitrary.</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
    
  
</div>

    </div>
  </body>
</html>
